version: '3.4'
services:
  # Redis Image is necessary for the asyncronous scheduling in the docker application
  redis-scheduler:
    restart: always
    container_name: neontoscheduler
    image: redis

  # This is the main application for the git metric aggregation
  neontometricsapi:
    restart: always
    container_name: neontometricsapi
    image: neontometrics
    # The starting of the mySQL-Database takes longer than the start up of the django webapp.

    # Wait-for-it.sh ensures that the database is up and running before starting django.
    command: "python manage.py runserver 0.0.0.0:8000"
    #command: 'python manage.py runserver 0.0.0.0:8000' 
    ports:
      - '8005:8000'
    depends_on:
      - neontometrics_db
      - migrateDB
    environment:
      db_password: 'KMmsWrwRBBeQLXDO'
      inDocker: "True"

  neontometrics_worker:
    restart: always
    image: neontometrics
    command: python manage.py rqworker
    deploy:
      replicas: 3
    depends_on:
      - neontometricsapi
      - neontometrics_db
      - migrateDB
    environment:
      db_password: 'KMmsWrwRBBeQLXDO'
      isWorker: "True"
      inDocker: "True"

  # the REST-Calculation Engine
  opi:
    ports:
      - '8085:8080'
    restart: always
    container_name: opi
    environment:
      JVM_OPTS: -Xmx12g -Xms12g -XX:MaxPermSize=2g
    build:
      context: ./Opi
    image: opi

  # The flutter Frontend
  frontend:
    ports:
      - '8006:8000'
    restart: always
    container_name: neontometricsfrontend
    build:
      context: ./frontend
    image: neontometricsfrontend

  # Creates the tables necessary in the database
  migrateDB:
    restart: "no"
    build:
      context: ./Git-Extension
    image: neontometrics
    depends_on:
      - neontometrics_db
    environment:
      db_password: 'KMmsWrwRBBeQLXDO'
      inDocker: "True"
    command: bash -c "python manage.py makemigrations rest --noinput && python manage.py migrate"

  # The Database for metric documentation
  neontometrics_db:
    restart: always
    container_name: neontometrics_db
    image: mariadb:latest
    ports:
      - '3366:3306'
    environment:
      MARIADB_DATABASE: 'neontometrics'
      MARIADB_USER: 'neontometrics'
      MARIADB_PASSWORD: 'KMmsWrwRBBeQLXDO'
      MARIADB_ROOT_PASSWORD: 'KMmsWrwRBBeQLXDO'
    volumes:
      - neontometricsdb:/var/lib/mysql
volumes:
  neontometricsdb:
