version: '3.4'
services:
  # Redis Image is necessary for the asyncronous scheduling in the docker application
  redis-scheduler:
    restart: always
    container_name: neonto_scheduler
    image: redis
    ports:
      - '6379:6379'

  # This is the main application for the git metric aggregation
  neontometrics_api:
    restart: always
    container_name: neontometrics_api
    build: 
      context: ./Git-Extension
    image: neontometrics
    # The starting of the mySQL-Database takes longer than the start up of the django webapp.
    # Wait-for-it.sh ensures that the database is up and running before starting django.
    command: python manage.py runserver 0.0.0.0:8000
    #command: 'python manage.py runserver 0.0.0.0:8000' 
    ports:
      - '8012:8000'
    depends_on:
      - neontometrics_db
    environment:
      db_password: 'KMmsWrwRBBeQLXDO'
      inDocker: "True"

  neontometrics_worker:
    restart: always
    container_name: neontometrics_worker
    build: 
      context: ./Git-Extension
    image: neontometrics
    command: python manage.py rqworker
    depends_on:
      - neontometrics_api
      - neontometrics_db
    environment:
     db_password: 'KMmsWrwRBBeQLXDO'
     inDocker: "True"
  
  # the REST-Calculation Engine
  opi:
    ports:
      - '8082:8080'
    restart: always
    container_name: opi
    environment:
      JVM_OPTS: -Xmx12g -Xms12g -XX:MaxPermSize=1024m
    build:
      context: ./Opi
    image: opi

  # The Database for metric documentation
  neontometrics_db:
    restart: always
    container_name: neontometrics_db
    image: mariadb:latest
    ports:
      - '3316:3306'
    environment:
      MYSQL_DATABASE: "neontometrics"
      MYSQL_USER: "neontometrics"
      MYSQL_PASSWORD: 'KMmsWrwRBBeQLXDO'
      MYSQL_ROOT_PASSWORD: 'KMmsWrwRBBeQLXDO'
    volumes:
      - neontometrics_db:/var/lib/mysql
volumes:
  neontometrics_db: